import React, { useState, useEffect, useRef, useCallback } from "react";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Separator } from "@/components/ui/separator";
import { 
  BrainCircuitIcon, 
  Loader2, 
  MessageSquare, 
  SendIcon,
  RefreshCcw,
  BadgeHelp,
  BookOpenCheck,
  AlertCircle,
  Copy,
  Check
} from "lucide-react";
import { useToast } from "@/hooks/use-toast";
import { TestQuestion } from "@shared/types";
import { cn } from "@/lib/utils";
import { smartSearch, findRelatedQuestions } from "@/lib/smartSearch";

// TypingEffect component for animated typing
const TypingEffect = ({ text }: { text: string }) => {
  const [displayedText, setDisplayedText] = useState("");
  const [currentIndex, setCurrentIndex] = useState(0);
  const [isThinking, setIsThinking] = useState(true);
  
  useEffect(() => {
    // Reset when text changes
    setDisplayedText("");
    setCurrentIndex(0);
    setIsThinking(true);
    
    // Simulate thinking for a short time
    const thinkingTimeout = setTimeout(() => {
      setIsThinking(false);
    }, 800 + Math.random() * 1200); // Random thinking time between 0.8-2 seconds
    
    return () => clearTimeout(thinkingTimeout);
  }, [text]);
  
  useEffect(() => {
    if (isThinking) return;
    
    if (currentIndex < text.length) {
      const timer = setTimeout(() => {
        // Add the next character
        setDisplayedText(prev => prev + text[currentIndex]);
        setCurrentIndex(prev => prev + 1);
      }, 20 + Math.random() * 30); // Random typing speed
      
      return () => clearTimeout(timer);
    }
  }, [currentIndex, text, isThinking]);
  
  return (
    <>
      {isThinking ? (
        <span className="inline-block animated-dots">جاري التفكير</span>
      ) : (
        <span>{displayedText}</span>
      )}
      {currentIndex < text.length && !isThinking && (
        <span className="cursor animate-pulse">|</span>
      )}
    </>
  );
};

interface AiAssistantProps {
  questions: TestQuestion[];
  userLevel?: number;
  onQuestionSelect?: (question: TestQuestion) => void;
  className?: string;
}

type MessageType = {
  id: string;
  text: string;
  sender: "user" | "assistant";
  timestamp: Date;
  relatedQuestions?: TestQuestion[];
  isTyping?: boolean;
};

// Predefined responses for common questions
const PREDEFINED_RESPONSES: Record<string, string> = {
  // أساسيات عامة واستقبال
  "مرحبا": "مرحباً بك يا يوسف! كيف يمكنني مساعدتك اليوم؟",
  "السلام عليكم": "وعليكم السلام ورحمة الله وبركاته! أهلاً بك في منصة قدراتك. كيف يمكنني مساعدتك اليوم؟",
  "كيف حالك": "أنا بخير، شكراً للسؤال! كيف يمكنني مساعدتك؟",
  "شكرا": "أهلاً، العفو! أسعدني أن أكون قادراً على مساعدتك. هل هناك شيء آخر تود معرفته؟",
  "شكرا لك": "العفو! سعيد بأنني استطعت مساعدتك. أنا هنا دائماً لمساعدتك في الاستعداد لاختبار القدرات. هل هناك سؤال آخر؟",
  "انت رائع": "شكراً جزيلاً! أنا سعيد بأنني أستطيع مساعدتك. وجودك هنا وتفاعلك مع المنصة هو ما يجعلها أفضل.",
  "انت غبي": "أعتذر إذا لم تكن إجاباتي مفيدة بما يكفي. أنا أتعلم باستمرار لتحسين أدائي. هل يمكنني مساعدتك بطريقة أخرى أو تجربة سؤال مختلف؟",
  "احبك": "شكراً لك! أنا هنا لمساعدتك في الاستعداد لاختبارات القدرات وتحسين مهاراتك. هل هناك موضوع معين ترغب في التعمق فيه؟",
  
  // معلومات عن التطبيق
  "ما هو هذا التطبيق": "هذا هو تطبيق قدراتك - منصة تعليمية تساعدك على التحضير لاختبارات القدرات العامة من خلال أكثر من 10,000 سؤال وتمارين تفاعلية ونصائح مخصصة.",
  "كيف استخدم التطبيق": "يمكنك استخدام التطبيق للبحث عن أسئلة، وممارسة اختبارات القدرات التفاعلية، والتحضير لاختبار قياس الرسمي. استكشف الأقسام المختلفة من القائمة الجانبية: المكتبة، اختبر قدراتك، اختبار قياس، إنشاء اختبار مخصص، والتحديات.",
  "ماذا يمكنك أن تفعل": "يمكنني مساعدتك في عدة مجالات: 1) الإجابة على أسئلتك حول اختبارات القدرات وقياس 2) شرح المفاهيم اللفظية والكمية 3) تقديم استراتيجيات حل الأسئلة 4) البحث عن أسئلة مشابهة لما تبحث عنه 5) اقتراح طرق مذاكرة فعالة 6) شرح معاني المصطلحات والكلمات الصعبة. أخبرني كيف يمكنني مساعدتك تحديداً.",

  // معلومات عن اختبار قياس
  "ما هو اختبار قياس": "اختبار قياس (الاختبار العام) هو اختبار وطني تقدمه هيئة تقويم التعليم والتدريب في المملكة العربية السعودية، ويقيس القدرات التحليلية والاستدلالية لدى الطلاب في مجالي اللغة والرياضيات. يتكون من 7 أقسام بإجمالي 120 سؤال في 120 دقيقة.",
  "كيف اذاكر لاختبار القدرات": "لتحضير فعال لاختبار القدرات، أنصحك بالآتي: 1) حل الكثير من الأسئلة التدريبية 2) التركيز على فهم المفاهيم بدلاً من الحفظ 3) تعلم استراتيجيات حل الأسئلة 4) إدارة وقتك بشكل صحيح 5) استخدم قسم 'اختبر قدراتك' في تطبيقنا للممارسة المنتظمة.",
  "ما هي أقسام الاختبار": "ينقسم اختبار قياس الرسمي إلى 7 أقسام: القسم 1-3: كل قسم يتكون من 24 سؤال (13 لفظي + 11 كمي) في 24 دقيقة، القسم 4: 11 سؤال كمي في 11 دقيقة، القسم 5: 13 سؤال لفظي في 13 دقيقة، القسم 6: 11 سؤال كمي في 11 دقيقة، القسم 7: 13 سؤال لفظي في 13 دقيقة.",
  "كم مدة الاختبار": "مدة اختبار قياس الرسمي هي 120 دقيقة (ساعتان) موزعة على سبعة أقسام. ويحتوي على 120 سؤالاً بالمجمل.",
  "أهمية اختبار القدرات": "اختبار القدرات له أهمية كبيرة لعدة أسباب:\n1. يشكل 40% من النسبة الموزونة للقبول في الجامعات السعودية\n2. يقيس قدرتك على التحليل والاستنتاج وليس فقط حفظ المعلومات\n3. يكشف عن الإمكانيات الكامنة لدى الطالب في مجالي اللغة والرياضيات\n4. يعد مؤشراً جيداً للتنبؤ بالنجاح الأكاديمي في المرحلة الجامعية\n5. يتيح المنافسة العادلة بين الطلاب من مختلف المدارس والمناطق",
  "نسبة النجاح في اختبار القدرات": "لا توجد نسبة نجاح ثابتة لاختبار القدرات، فهو اختبار معياري يقارن أداء الطالب بأداء زملائه. تتراوح الدرجات بين 0 إلى 100، ومتوسط الدرجات عادة حول 65. الدرجة المئينية هي الأهم، وتشير إلى نسبة الطلاب الذين حصلت على درجة أعلى منهم. مثلا: إذا حصلت على مئيني 80، فهذا يعني أنك تفوقت على 80% من المتقدمين.",
  "متى يقام اختبار قياس": "يُعقد اختبار قياس (القدرات العامة) عدة مرات على مدار العام الدراسي، عادة على ثلاث فترات رئيسية: الفترة الأولى في الفصل الدراسي الأول، والفترة الثانية في الفصل الدراسي الثاني، والفترة الصيفية. يتم الإعلان عن مواعيد التسجيل والاختبار عبر موقع هيئة تقويم التعليم والتدريب (etec.gov.sa). يمكن للطالب التقدم للاختبار عدة مرات لتحسين درجته.",
  "الفرق بين اختبار القدرات والتحصيلي": "الفرق الأساسي بين اختبار القدرات والتحصيلي:\n\nاختبار القدرات العامة:\n• يقيس المهارات التحليلية والاستدلالية\n• لا يعتمد على حفظ معلومات محددة\n• يركز على الفهم واستخدام المنطق\n• يشمل أسئلة لفظية وكمية عامة\n• يختبر ما تعلمته خلال حياتك التعليمية كاملة\n\nاختبار التحصيلي:\n• يقيس المعرفة العلمية المكتسبة\n• يعتمد على المحتوى الدراسي للمرحلة الثانوية\n• يركز على المعلومات المحددة في المنهج\n• يشمل أسئلة في المواد العلمية أو الأدبية حسب التخصص\n• يختبر ما تعلمته في المرحلة الثانوية تحديداً",
  "كيف أحسن مستواي في اختبار القدرات": "إليك إستراتيجية شاملة لتحسين مستواك في اختبار القدرات العامة:\n\n1. التقييم الذاتي:\n   • حل اختبار تجريبي كامل لتحديد نقاط القوة والضعف\n   • حلل نتائجك حسب أنواع الأسئلة والأقسام\n\n2. خطة دراسة منظمة:\n   • خصص 60-90 دقيقة يومياً على مدار 8-12 أسبوع\n   • قسم وقتك بين القسمين اللفظي والكمي حسب احتياجك\n   • ركز على المهارات الأساسية أولاً قبل الانتقال للمتقدمة\n\n3. تطوير المهارات اللفظية:\n   • اقرأ يومياً لتوسيع مفرداتك\n   • تدرب على استنتاج المعاني من السياق\n   • مارس حل أنماط أسئلة المتشابهات والمتضادات\n\n4. تطوير المهارات الكمية:\n   • راجع المفاهيم الرياضية الأساسية\n   • تدرب على الحسابات السريعة بدون آلة حاسبة\n   • طور مهارة تحويل المسائل اللفظية إلى معادلات\n\n5. ممارسة منتظمة:\n   • حل 20-30 سؤالاً يومياً من أنواع مختلفة\n   • خصص يوماً أسبوعياً لاختبار كامل بتوقيت فعلي\n   • حلل أخطاءك وتعلم منها\n\n6. استراتيجيات الاختبار:\n   • تدرب على إدارة الوقت (دقيقة لكل سؤال)\n   • طور استراتيجية للأسئلة الصعبة (التخمين الذكي)\n   • تعلم تقنيات استبعاد الإجابات غير المنطقية",

  // معلومات عن نظام المنصة
  "ما هي فائدة النقاط": "تمثل النقاط مستوى تقدمك في المنصة. كلما حصلت على نقاط أكثر، كلما ارتفع مستواك وفتحت مستويات أصعب من الأسئلة. يمكنك الحصول على النقاط من خلال الإجابة بشكل صحيح على الأسئلة في قسم 'اختبر قدراتك' وفي اختبارات قياس التجريبية.",
  "كيف انشئ اختبار مخصص": "يمكنك إنشاء اختبار مخصص من خلال الذهاب إلى قسم 'اختبارات مخصصة' في القائمة الجانبية، ثم اختيار عدد الأسئلة والمدة الزمنية ونوع الأسئلة (لفظي أو كمي) ومستوى الصعوبة الذي تريده.",
  "ما هي اللهجات المدعومة": "تدعم منصة قدراتك اللهجات التالية: الفصحى (المعيارية)، اللهجة السعودية، اللهجة المصرية، اللهجة الخليجية، وغيرها. يمكنك البحث عن الأسئلة حسب اللهجة في قسم المكتبة.",
  
  // القدرات التحليلية
  "قارن بين الاختبارات": "هناك عدة أنواع من الاختبارات في منصة قدراتك:\n1. اختبار قياس: محاكاة للاختبار الرسمي بـ 120 سؤال في 120 دقيقة موزعة على 7 أقسام.\n2. اختبر قدراتك: اختبارات قصيرة تتدرج من المستوى المبتدئ إلى المتقدم.\n3. التحديات: اختبارات صعبة تفتح تدريجياً حسب تقدمك ونقاطك.\n4. اختبارات مخصصة: يمكنك إنشاؤها حسب احتياجاتك من حيث المحتوى والمدة.\nالفرق الرئيسي هو أن قياس هو محاكاة للاختبار الرسمي بينما البقية أدوات تدريب مرنة.",
  "الفرق بين القدرات اللفظية والكمية": "الفرق بين القدرات اللفظية والكمية:\n\nالقدرات اللفظية:\n• تركز على: المهارات اللغوية والاستدلال المنطقي اللفظي\n• تشمل: فهم النصوص، المعاني، المترادفات، المتضادات، التناظر اللفظي، إكمال الجمل\n• تقيس: القدرة على فهم اللغة وتحليل المعلومات المكتوبة واستخلاص النتائج المنطقية\n\nالقدرات الكمية:\n• تركز على: المهارات الرياضية والتفكير المنطقي الرقمي\n• تشمل: الحساب، الجبر، الهندسة، تحليل البيانات، الاحتماليات\n• تقيس: القدرة على فهم العلاقات الرقمية وحل المشكلات الرياضية\n\nكلاهما يحتاج إلى مهارات تحليلية، لكن الأول يتعامل مع اللغة والثاني مع الأرقام.",
  "حلل مسألة رياضية": "لتحليل مسألة رياضية، اتبع هذه الخطوات المنهجية:\n\n1. اقرأ المسألة بتمعن وحدد المعطيات والمطلوب\n2. ترجم المسألة الكلامية إلى رموز ومعادلات رياضية\n3. حدد القانون أو الاستراتيجية المناسبة للحل\n4. نفذ الحل خطوة بخطوة مع تنظيم العمليات الحسابية\n5. تحقق من المعقولية المنطقية للنتيجة\n\nمثال: إذا قطع سائق 240 كم في 3 ساعات، فما سرعته؟\n- المعطيات: المسافة = 240 كم، الزمن = 3 ساعات\n- المطلوب: السرعة\n- القانون: السرعة = المسافة ÷ الزمن\n- الحل: السرعة = 240 ÷ 3 = 80 كم/ساعة\n- التحقق: 80 × 3 = 240 ✓",
  
  // إبداع واقتراح
  "اقترح لي طريقة مذاكرة": "إليك خطة مذاكرة منظمة لاختبار القدرات:\n1. المرحلة الأولى (4 أسابيع قبل الاختبار): تعلم المفاهيم الأساسية واستراتيجيات الحل، مع تخصيص ساعة يومياً.\n2. المرحلة الثانية (أسبوعان): حل اختبارات قصيرة على كل مهارة، مع تحليل الأخطاء وساعتين يومياً.\n3. المرحلة الثالثة (الأسبوع الأخير): اختبارات كاملة محاكية لقياس في ظروف مشابهة، مع التدرب على إدارة الوقت.\n4. يوم الاختبار: احصل على قسط كافٍ من النوم، تناول وجبة خفيفة، وصل مبكراً لمركز الاختبار.\nالنصيحة الذهبية: استخدم قسم 'اختبر قدراتك' للتدرب المنظم حسب المستويات، ثم التحديات.",
  "اكتب قصة قصيرة": "قصة قصيرة: \"الاختبار الأخير\"\n\nوقف أحمد أمام باب قاعة الاختبار، قلبه يخفق بشدة. كان هذا اختبار القدرات الأخير له قبل التقديم للجامعة. تذكر كيف بدأ رحلته قبل ثلاثة أشهر، حين كان يخشى حتى من مجرد التفكير في الاختبار.\n\nأخذ نفساً عميقاً وتذكر كل ساعات المذاكرة والتدريب على منصة \"قدراتك\". تذكر كيف تحسنت درجاته تدريجياً من 65 إلى 85 ثم 92 في الاختبارات التجريبية.\n\nدخل القاعة بثقة لم يعهدها من قبل. جلس وبدأ يقرأ الأسئلة. ابتسم عندما وجد سؤالاً مشابهاً لما حله بالأمس. وآخر شبيه بما تدرب عليه الأسبوع الماضي.\n\nبعد شهر، وصلته النتيجة: 98 من 100. لم تكن المعجزة في النتيجة، بل في رحلة التحول من الخوف إلى الثقة، ومن التردد إلى الإتقان.\n\nأدرك أحمد أن النجاح ليس في الدرجة النهائية، بل في كل خطوة صغيرة على الطريق.",
  "اقترح عنوان مشروع تخرج": "إليك 5 عناوين مقترحة لمشاريع تخرج مبتكرة:\n\n1. \"تطوير منصة تفاعلية لتعليم اللغة العربية باستخدام الذكاء الاصطناعي والتعلم التكيفي\"\n\n2. \"نظام ذكي للتنبؤ بأداء الطلاب في اختبارات القدرات باستخدام تقنيات التعلم الآلي وتحليل البيانات\"\n\n3. \"تصميم تطبيق واقع معزز لتبسيط المفاهيم الرياضية المعقدة للطلاب في المرحلة الثانوية\"\n\n4. \"منصة تعاونية لإنشاء وتبادل أسئلة اختبارات القدرات المخصصة مع نظام تقييم الجودة التلقائي\"\n\n5. \"تطوير خوارزميات متقدمة لتحليل النصوص العربية واكتشاف الأنماط اللغوية في اختبارات القدرات اللفظية\"",
  
  // المعرفة العامة
  "ما هي أهم مهارات القدرات اللفظية": "أهم مهارات القدرات اللفظية التي يجب إتقانها:\n1. إكمال الجمل: اختيار الكلمة المناسبة نحوياً ودلالياً.\n2. المترادفات والمتضادات: فهم العلاقات بين الكلمات.\n3. قياس المنطق اللفظي: إيجاد العلاقة المنطقية بين مجموعات الكلمات.\n4. القراءة والاستيعاب: فهم النصوص واستخراج المعلومات.\n5. التناظر اللفظي: فهم العلاقات بين أزواج الكلمات.\n6. التصنيف المنطقي: تحديد عناصر تنتمي لمجموعة معينة.\nركز على بناء رصيدك اللغوي وتطوير مهارات التفكير المنطقي.",
  "ما هي أهم مهارات القدرات الكمية": "أهم مهارات القدرات الكمية المطلوبة:\n1. الحساب الأساسي: العمليات الحسابية والكسور والنسب المئوية.\n2. الجبر: حل المعادلات البسيطة والمتوسطة.\n3. الهندسة: حساب مساحة ومحيط الأشكال الأساسية.\n4. الاحتمالات والإحصاء: فهم مبادئ الاحتمالات والمتوسطات.\n5. التفكير المنطقي الرياضي: حل المسائل الكلامية وتحويلها لمعادلات.\n6. تفسير البيانات: قراءة الرسوم البيانية والجداول.\nركز على فهم المفاهيم وتطبيقها في سياقات مختلفة بدلاً من الحفظ.",
  "ما هي مهارات التناظر اللفظي": "مهارات التناظر اللفظي في اختبار القدرات:\n\n1. فهم أنواع العلاقات:\n   - علاقة الجزء بالكل (عجلة : سيارة)\n   - علاقة الترادف (فرح : سرور)\n   - علاقة التضاد (ساخن : بارد)\n   - علاقة السبب والنتيجة (جفاف : عطش)\n   - علاقة الخصائص (أسد : شجاعة)\n   - علاقة الوظيفة (قلم : كتابة)\n\n2. خطوات الحل:\n   - حدد العلاقة بين الكلمتين الأولى والثانية\n   - طبق نفس نوع العلاقة على الكلمة الثالثة لاستنتاج الرابعة\n   - استبعد الإجابات التي لا تعكس نفس نوع العلاقة\n\n3. استراتيجيات تدريب:\n   - اقرأ كثيراً لتوسيع مفرداتك\n   - تدرب على تصنيف الكلمات والمفاهيم\n   - حل أسئلة متنوعة من أنماط العلاقات المختلفة\n   - تعرف على قواعد اللغة العربية لفهم العلاقات النحوية",
  "كيفية حل أسئلة التناظر اللفظي": "لحل أسئلة التناظر اللفظي بكفاءة عالية، اتبع هذه الطريقة المنهجية:\n\n1. استراتيجية الحل النموذجية:\n   • اقرأ زوج الكلمات الأول (أ : ب) وحدد العلاقة بينهما بجملة واضحة\n   • انظر للكلمة الثالثة (ج) وتوقع الكلمة الرابعة قبل النظر للخيارات\n   • حدد من الخيارات الكلمة التي تشكل مع (ج) نفس العلاقة بين (أ) و(ب)\n\n2. أمثلة على العلاقات الشائعة:\n   • (قلم : كتابة) - علاقة أداة بوظيفتها\n      - مثال آخر: (مقص : قص)\n   • (طبيب : مستشفى) - علاقة شخص بمكان عمله\n      - مثال آخر: (معلم : مدرسة)\n   • (غني : فقير) - علاقة تضاد\n      - مثال آخر: (ضوء : ظلام)\n\n3. الأخطاء الشائعة التي يجب تجنبها:\n   • الانخداع بالتشابه اللفظي بدلاً من العلاقة المنطقية\n   • الخلط بين أنواع العلاقات المختلفة\n   • التسرع وعدم تحديد العلاقة بدقة\n\n4. مثال محلول:\n   سؤال: (كتاب : صفحات) كما (بيت : ؟)\n   • تحليل العلاقة: الكتاب يتكون من صفحات (علاقة كل بأجزائه)\n   • الإجابة الصحيحة: غرف (لأن البيت يتكون من غرف، بنفس علاقة الكل بأجزائه)",
  "مثال على سؤال إكمال الجمل": "سؤال إكمال الجمل: \"من أراد أن ............. إلى مرتبة العلماء فعليه بمداومة ................\"\n\nالإجابات المحتملة:\nأ) يصل، القراءة\nب) يصعد، الدراسة\nج) يرتقي، البحث\nد) يرقى، المذاكرة\n\nالتحليل:\n1. الفراغ الأول يحتاج إلى فعل يناسب الوصول إلى مكانة عالية\n2. الفراغ الثاني يحتاج إلى مصدر يعبر عن النشاط المناسب للوصول إلى العلم\n\nالإجابة الصحيحة: ج) يرتقي، البحث\nالسبب: \n• كلمة \"يرتقي\" تتناسب مع \"مرتبة\" لأن الارتقاء يعني الصعود التدريجي\n• كلمة \"البحث\" هي أنسب نشاط للعلماء فهي أعمق من مجرد القراءة أو المذاكرة\n\nاستراتيجية حل أسئلة إكمال الجمل:\n1. اقرأ الجملة كاملة لفهم السياق العام أولاً\n2. ابحث عن دلالات تشير إلى العلاقات النحوية والدلالية المطلوبة\n3. فكر في الإجابة المحتملة قبل قراءة الخيارات لتجنب التشويش\n4. اختبر كل خيار بوضعه في الجملة للتأكد من ملاءمته نحوياً ودلالياً",
  "نموذج لسؤال قدرات لفظي": "نموذج سؤال قدرات لفظي (المتضادات):\n\nسؤال: مضاد كلمة \"الصفاء\" هو:\nأ) النقاء\nب) الرواسب\nج) الكدر\nد) الصواب\n\nالحل والتحليل:\n1. \"الصفاء\" تعني النقاء وخلو الشيء من الشوائب\n2. نبحث عن الكلمة التي تحمل المعنى المعاكس تماماً\n\nالإجابة الصحيحة: ج) الكدر\nالسبب: الكدر يعني عدم الصفاء ووجود الشوائب في السائل أو المعنى المعنوي لوجود الهموم والأحزان\n\nتحليل بقية الخيارات:\nأ) النقاء: مرادف للصفاء وليس مضاداً له\nب) الرواسب: وإن كانت تدل على عدم الصفاء، لكنها تشير إلى ما يترسب في قاع السائل وليست المضاد المباشر للصفاء\nد) الصواب: لا علاقة لها بالصفاء فهي تتعلق بالحق والصحة\n\nنصائح لحل أسئلة المتضادات:\n• ابحث عن المضاد المباشر وليس مجرد كلمة مختلفة\n• انتبه للسياق اللغوي والمعنى الأساسي للكلمة\n• احذر من الكلمات التي قد تبدو مرتبطة لكنها ليست أضداداً حقيقية",
  "مثال سؤال استيعاب مقروء": "نموذج سؤال القراءة والاستيعاب:\n\nاقرأ القطعة التالية ثم أجب:\n\"تعددت الدراسات التي تناولت أثر وسائل التواصل الاجتماعي على الشباب. وقد خلص بعض الباحثين إلى أن لهذه الوسائل جوانب إيجابية تتمثل في توسيع المدارك وتبادل الثقافات، بينما يرى آخرون أن سلبياتها تفوق إيجابياتها، وخاصة فيما يتعلق بإضاعة الوقت والتأثير السلبي على التحصيل الدراسي. وتشير البيانات الحديثة إلى أن الشباب يقضون ما معدله أربع ساعات يومياً في تصفح مواقع التواصل الاجتماعي.\"\n\nالسؤال: ما هو الاستنتاج الصحيح من الفقرة؟\nأ) وسائل التواصل الاجتماعي ضارة بالشباب\nب) وسائل التواصل الاجتماعي مفيدة للشباب\nج) هناك اختلاف في الرأي حول تأثير وسائل التواصل الاجتماعي\nد) الشباب يستخدمون وسائل التواصل الاجتماعي بشكل مفرط\n\nالإجابة الصحيحة: ج) هناك اختلاف في الرأي حول تأثير وسائل التواصل الاجتماعي\nالسبب: النص يوضح وجود وجهتي نظر مختلفتين: بعض الباحثين يرون إيجابيات، وآخرون يرون أن السلبيات أكثر\n\nنصائح لحل أسئلة الاستيعاب:\n1. اقرأ النص بتمعن وركز على الفكرة الرئيسية\n2. ابحث عن كلمات مفتاحية مثل \"لكن\"، \"بينما\"، \"من ناحية أخرى\" التي تشير إلى وجود مقارنة أو تناقض\n3. تجنب الاستنتاجات المتطرفة أو المبالغ فيها\n4. حدد ما إذا كان السؤال يطلب حقيقة صريحة أو استنتاجاً ضمنياً",
  
  // التخصصات الدقيقة
  "اشرح الفرق بين اللهجات العربية": "اللهجات العربية المدعومة في منصتنا تتميز بفروق لغوية وصوتية مهمة:\n1. الفصحى: اللغة المعيارية المستخدمة في الكتابة والإعلام، وتتميز بضبط أواخر الكلمات (الإعراب).\n2. اللهجة السعودية: تتميز بنطق القاف كما هي، واستخدام مفردات خاصة مثل (مرة) بمعنى جداً، و(عشان) بمعنى لأجل.\n3. اللهجة المصرية: تحول الجيم إلى 'گ' في بعض الكلمات، وتستخدم مفردات مثل (أوي) بمعنى جداً، و(عايز) بمعنى أريد.\n4. اللهجة الخليجية: تشترك مع السعودية في بعض السمات مع وجود مفردات خاصة مثل (شنو) بمعنى ماذا، و(يبا) للمناداة.\nفهم هذه الفروق يساعدك في التعامل مع أسئلة القدرات اللفظية المتنوعة.",
  "نموذج سؤال قدرات كمي": "نموذج سؤال قدرات كمي (مسألة نسبة وتناسب):\n\nسؤال: إذا استطاع 8 عمال بناء جدار في 15 يوماً، فما عدد الأيام اللازمة لبناء الجدار نفسه بواسطة 10 عمال بنفس الكفاءة؟\n\nأ) 13 يوماً\nب) 12 يوماً\nج) 18.75 يوماً\nد) 16.5 يوماً\n\nالحل والتحليل:\n1. نحدد العلاقة بين عدد العمال وعدد الأيام: العلاقة عكسية (كلما زاد عدد العمال قلَّ الوقت اللازم والعكس صحيح)\n2. نستخدم قانون النسبة العكسية: عدد العمال × عدد الأيام = ثابت\n\nالحل خطوة بخطوة:\n- لدينا: 8 عمال × 15 يوماً = 120 (هذا هو الثابت)\n- إذن: 10 عمال × س = 120\n- س = 120 ÷ 10 = 12 يوماً\n\nالإجابة الصحيحة: ب) 12 يوماً\n\nإستراتيجيات حل مسائل النسبة والتناسب:\n1. حدد أولاً نوع العلاقة: طردية أم عكسية\n2. إذا كانت العلاقة طردية، فإن (أ ÷ ب = ج ÷ د)\n3. إذا كانت العلاقة عكسية، فإن (أ × ب = ج × د)\n4. اكتب المعادلة وحلها خطوة بخطوة",
  "مثال مسألة نظرية فيثاغورس": "نموذج سؤال قدرات كمي (نظرية فيثاغورس):\n\nسؤال: في المثلث القائم الزاوية أ ب ج، الزاوية ب قائمة، وطول الضلع أ ب = 3 سم، وطول الضلع ب ج = 4 سم. ما هو طول الوتر أ ج بالسنتيمتر؟\n\nأ) 5\nب) 7\nج) 12\nد) 25\n\nالحل والتحليل:\n1. نستخدم نظرية فيثاغورس: في المثلث القائم الزاوية، مربع طول الوتر يساوي مجموع مربعي طولي الضلعين الآخرين\n2. (طول الوتر)² = (طول الضلع الأول)² + (طول الضلع الثاني)²\n\nالحل:\n- (أ ج)² = (أ ب)² + (ب ج)²\n- (أ ج)² = 3² + 4²\n- (أ ج)² = 9 + 16\n- (أ ج)² = 25\n- أ ج = 5 سم\n\nالإجابة الصحيحة: أ) 5\n\nتطبيقات نظرية فيثاغورس:\n1. حساب أطوال الأضلاع في المثلثات القائمة\n2. تحديد ما إذا كان المثلث قائم الزاوية\n3. حساب المسافات بين النقاط في المستوى الإحداثي\n\nملاحظة مهمة: المثلث 3-4-5 هو مثلث فيثاغورسي مشهور (مثلث قائم الزاوية بأطوال أعداد صحيحة)، حفظه يساعد في الحل السريع للأسئلة",
  "أمثلة لأسئلة المتواليات": "أسئلة المتواليات في القدرات الكمية:\n\nنموذج 1: أكمل المتوالية العددية: 2، 6، 18، 54، ...\nالحل: لاحظ أن كل عدد = العدد السابق × 3\n2 × 3 = 6\n6 × 3 = 18\n18 × 3 = 54\n54 × 3 = 162 (الإجابة)\n\nنموذج 2: أوجد الرقم المفقود: 1، 4، 9، _، 25، 36، 49\nالحل: لاحظ أن المتوالية هي مربعات الأعداد الطبيعية\n1 = 1²\n4 = 2²\n9 = 3²\n_ = 4² = 16 (الإجابة)\n25 = 5²\n\nاستراتيجيات حل أسئلة المتواليات:\n1. ابحث عن نمط ثابت: جمع، طرح، ضرب، قسمة\n2. حاول إيجاد الفرق بين كل عددين متتاليين\n3. تحقق إذا كانت أعداداً مربعة، أو مكعبة، أو قوى عدد معين\n4. في المتواليات المعقدة، قد يكون هناك نمطان مختلفان يتناوبان\n\nبعض أنواع المتواليات الشائعة:\n• المتوالية الحسابية: الفرق بين أي حدين متتاليين ثابت\n• المتوالية الهندسية: النسبة بين أي حدين متتاليين ثابتة\n• متوالية فيبوناتشي: كل حد يساوي مجموع الحدين السابقين (1، 1، 2، 3، 5، 8، ...)",
  "حل مسائل الاحتمالات": "استراتيجية حل مسائل الاحتمالات في القدرات الكمية:\n\nالقانون الأساسي: الاحتمال = عدد النواتج المطلوبة ÷ العدد الكلي للنواتج الممكنة\n\nمثال محلول:\nسؤال: كيس يحتوي على 5 كرات حمراء و3 كرات زرقاء و2 كرات خضراء. إذا سحبت كرة واحدة عشوائياً، ما احتمال أن تكون حمراء؟\n\nالحل:\n- عدد النواتج المطلوبة = عدد الكرات الحمراء = 5\n- العدد الكلي للكرات = 5 + 3 + 2 = 10\n- الاحتمال = 5 ÷ 10 = 1/2 = 0.5\n\nقواعد أساسية للاحتمالات:\n1. قاعدة الجمع: احتمال وقوع أ أو ب = احتمال أ + احتمال ب (إذا كانت أ و ب حدثين منفصلين)\n2. قاعدة الضرب: احتمال وقوع أ و ب معاً = احتمال أ × احتمال ب (إذا كان الحدثان مستقلين)\n3. احتمال عدم وقوع الحدث = 1 - احتمال وقوع الحدث\n\nمثال آخر:\nسؤال: ما احتمال الحصول على عدد زوجي عند رمي نرد عادل مرة واحدة؟\n\nالحل:\n- الأعداد الزوجية على النرد: 2، 4، 6 (عددها 3)\n- العدد الكلي للاحتمالات: 6\n- الاحتمال = 3 ÷ 6 = 1/2\n\nنصائح لحل مسائل الاحتمالات:\n• حدد بدقة ما هو المطلوب في السؤال\n• اكتب جميع النواتج الممكنة إذا كان عددها قليلاً\n• استخدم الرسم البياني الشجري للحالات المعقدة\n• تأكد من أن جميع النواتج متساوية في احتمال حدوثها",
  "ما الفرق بين السكري النوع الأول والنوع الثاني": "الفرق بين النوع الأول والنوع الثاني من مرض السكري:\n\nالنوع الأول:\n• سببه: مناعي ذاتي (الجهاز المناعي يهاجم خلايا بيتا في البنكرياس)\n• يظهر غالباً: في سن مبكرة (الطفولة والمراهقة)\n• إنتاج الأنسولين: منعدم أو قليل جداً\n• العلاج: يحتاج حقن أنسولين بشكل دائم\n• الوزن: المرضى غالباً نحيفون\n\nالنوع الثاني:\n• سببه: مقاومة الخلايا للأنسولين\n• يظهر غالباً: في سن متأخرة (بعد 40 سنة)\n• إنتاج الأنسولين: موجود لكن الجسم لا يستجيب له بشكل كافٍ\n• العلاج: يمكن التحكم بالنظام الغذائي والحبوب وأحياناً الأنسولين\n• الوزن: المرضى غالباً يعانون من زيادة الوزن أو السمنة",
  "ما هي المعادلات التربيعية": "المعادلات التربيعية في القدرات الكمية:\n\n1. الصيغة العامة: ax² + bx + c = 0 حيث a ≠ 0\n\n2. طرق الحل:\n   - القانون العام: x = [-b ± √(b² - 4ac)] ÷ 2a\n   - التحليل: تحليل الطرف الأيسر إلى عوامل ثم حل كل عامل = صفر\n   - إكمال المربع: تحويل المعادلة إلى صيغة (x + p)² = q\n\n3. الخصائص المهمة:\n   - المعادلة لها جذران (حلان) قد يكونان حقيقيين أو تخيليين\n   - مجموع الجذرين = -b/a\n   - حاصل ضرب الجذرين = c/a\n\n4. المميز (Δ): b² - 4ac\n   - إذا كان Δ > 0: جذران حقيقيان مختلفان\n   - إذا كان Δ = 0: جذر حقيقي واحد مكرر\n   - إذا كان Δ < 0: جذران تخيليان (مركبان)\n\nمثال: حل x² - 5x + 6 = 0\nباستخدام التحليل: (x - 2)(x - 3) = 0\nإذن: x = 2 أو x = 3",
  
  // التعامل مع أوامر تنفيذية
  "احسب مساحة المثلث": "لحساب مساحة المثلث، نستخدم القانون: المساحة = (القاعدة × الارتفاع) ÷ 2\n\nمثال: مثلث قاعدته 6 سم وارتفاعه 8 سم\nالمساحة = (6 × 8) ÷ 2 = 48 ÷ 2 = 24 سم²\n\nيمكنك أيضاً استخدام قانون هيرون إذا كنت تعرف أطوال الأضلاع الثلاثة:\nالمساحة = √[نق × (نق-أ) × (نق-ب) × (نق-جـ)]\nحيث نق = نصف محيط المثلث = (أ + ب + جـ) ÷ 2",
  "لخص مبادئ التفكير النقدي": "مبادئ التفكير النقدي في خمس نقاط أساسية:\n1. الشك المنهجي: لا تقبل المعلومات دون تمحيص ودليل.\n2. تحليل الافتراضات: اكتشاف المسلمات غير المصرح بها وراء الأفكار.\n3. تقييم الأدلة: فحص قوة الأدلة ومصداقيتها ومدى ارتباطها بالادعاء.\n4. النظر من زوايا متعددة: استكشاف وجهات نظر مختلفة قبل الحكم.\n5. الاستنتاج المنطقي: بناء استنتاجات تستند إلى أدلة وتحليل منطقي سليم.\n\nتطبيق هذه المبادئ يساعدك في التعامل مع أسئلة القدرات اللفظية والكمية التي تتطلب تفكيراً منطقياً.",
  "شرح قوانين المشتقات": "قوانين المشتقات الأساسية في الرياضيات:\n\n1. مشتقة الثابت: إذا f(x) = c، فإن f'(x) = 0\n\n2. مشتقة الدالة الأسية: إذا f(x) = xⁿ، فإن f'(x) = n×xⁿ⁻¹\n\n3. قاعدة الجمع والطرح: (f±g)' = f'±g'\n\n4. قاعدة الضرب: (f×g)' = f'×g + f×g'\n\n5. قاعدة القسمة: (f/g)' = (f'×g - f×g')/g²\n\n6. قاعدة السلسلة: إذا y = f(g(x))، فإن dy/dx = (dy/dg)×(dg/dx)\n\n7. مشتقات الدوال المثلثية:\n   - (sin x)' = cos x\n   - (cos x)' = -sin x\n   - (tan x)' = sec² x\n\n8. مشتقات الدوال اللوغاريتمية:\n   - (ln x)' = 1/x\n   - (log_a x)' = 1/(x×ln a)\n\nمثال: مشتقة f(x) = 3x² + 2x - 5\nf'(x) = 6x + 2",
  
  // الذكاء العاطفي واللباقة
  "أنا متوتر من الاختبار": "من الطبيعي تماماً أن تشعر بالتوتر قبل اختبار مهم مثل قياس. هذا يدل على اهتمامك بالأمر! إليك بعض النصائح للتعامل مع هذا التوتر:\n\n1. خذ نفساً عميقاً ببطء عندما تشعر بالتوتر يزداد.\n2. تذكر أنك قد تدربت وأنك مستعد.\n3. ركز على الأسئلة واحداً تلو الآخر، ولا تفكر بالاختبار ككل.\n4. استخدم منصة قدراتك للتدرب على محاكاة ظروف الاختبار للتعود عليها.\n5. فكر في النجاح وليس في الخوف من الفشل.\n\nأنت قادر على اجتياز هذا الاختبار، وتذكر أن بإمكانك دائماً المحاولة مرة أخرى إذا لم تحقق ما تريد هذه المرة.",
  "شعرت بالإحباط": "أفهم شعورك بالإحباط تماماً، فمسار التعلم والتحضير للاختبار ليس سهلاً دائماً. ولكن تذكر أن الصعوبات هي جزء طبيعي من رحلة النجاح، وكل شخص ناجح واجه العقبات والإحباط.\n\nنصائح للتغلب على الإحباط:\n1. خذ استراحة قصيرة وابتعد عن الدراسة لبضع ساعات.\n2. قسم المهام الكبيرة إلى خطوات صغيرة يمكن تحقيقها.\n3. احتفل بالإنجازات الصغيرة على طول الطريق.\n4. تواصل مع زملائك الذين يمرون بنفس التجربة.\n5. ركز على تقدمك الشخصي وليس على مقارنة نفسك بالآخرين.\n\nأنت تتقدم خطوة بخطوة، واستمرارك رغم الإحباط هو دليل على قوتك وعزيمتك.",
  "كيف أتعامل مع ضغط الوقت": "التعامل مع ضغط الوقت أثناء اختبار القدرات:\n\n1. التحضير المسبق:\n   - تدرب على اختبارات كاملة بتوقيت حقيقي\n   - تعرف على متوسط الوقت المطلوب لكل نوع من الأسئلة\n\n2. استراتيجيات أثناء الاختبار:\n   - ابدأ بالأسئلة السهلة وعُد للصعبة لاحقاً\n   - خصص 1-2 دقيقة لكل سؤال وتجاوز الأسئلة المستغرقة\n   - راقب الوقت كل 15 دقيقة لتتأكد من التزامك بالجدول\n   - استخدم الإقصاء المنطقي للخيارات غير المنطقية\n\n3. تقنيات التركيز:\n   - خذ نفساً عميقاً عند الشعور بالضغط\n   - ركز على السؤال الحالي فقط\n   - تجاهل الطلاب من حولك\n\n4. للأسئلة الصعبة:\n   - ضع علامة واتركها مؤقتاً\n   - استخدم آخر 5 دقائق للعودة إليها\n   - خمن بذكاء إذا لم يتبق وقت (لا تترك سؤالاً بدون إجابة)",
  
  // أمثلة على أسئلة الاختبار
  "اقترح 3 أفكار تسويقية": "إليك 3 أفكار تسويقية مبتكرة يمكن تطبيقها لمشروع ناشئ:\n\n1. التسويق بالمحتوى التفاعلي: إنشاء محتوى تعليمي مفيد مرتبط بمجالك (مدونات، فيديوهات قصيرة، انفوجرافيك) مع تضمينه اختبارات قصيرة أو استطلاعات تفاعلية تزيد من مشاركة الجمهور.\n\n2. برنامج السفراء الرقميين: استقطاب مجموعة مخلصة من العملاء الراضين كسفراء للعلامة التجارية، ومنحهم مزايا خاصة مقابل مشاركتهم تجاربهم الإيجابية عبر منصات التواصل الاجتماعي.\n\n3. تسويق المناسبات المصغّرة: تنظيم فعاليات افتراضية صغيرة ومتخصصة (ورش عمل، جلسات حوارية) تستهدف شرائح محددة من جمهورك المستهدف، مما يخلق تجربة شخصية وحصرية ويبني علاقات أعمق مع العملاء المحتملين.",
  "اكتب كود بايثون لحساب المتوسط": "إليك كود بلغة Python لحساب متوسط مجموعة أرقام:\n\n```python\ndef calculate_average(numbers):\n    # التحقق من أن القائمة ليست فارغة\n    if not numbers:\n        return 0\n    \n    # حساب مجموع القيم\n    total = sum(numbers)\n    \n    # حساب عدد القيم\n    count = len(numbers)\n    \n    # حساب المتوسط وإرجاعه\n    return total / count\n\n# مثال للاستخدام\nnumbers_list = [10, 20, 30, 40, 50]\nresult = calculate_average(numbers_list)\nprint(f\"المتوسط هو: {result}\")\n```\n\nهذا الكود يقوم بإنشاء دالة تأخذ قائمة أرقام وتعيد متوسطها الحسابي، مع التحقق من أن القائمة ليست فارغة لتجنب الأخطاء.",
  "ترجم هذه الفقرة للإنجليزية": "سأساعدك في ترجمة فقرة من العربية إلى الإنجليزية. يرجى كتابة الفقرة المراد ترجمتها، وسأقوم بترجمتها بشكل دقيق مع مراعاة السياق والمصطلحات المناسبة.",
  "ما هو التاريخ اليوم": "عذراً، أنا مساعد محلي لا أستطيع معرفة التاريخ الحالي بدقة. أنا مصمم للمساعدة في أسئلة اختبارات القدرات والمعلومات التعليمية. يمكنك الاطلاع على التاريخ من خلال جهازك أو سؤال مساعد متصل بالإنترنت. هل يمكنني مساعدتك في موضوع يتعلق باختبارات القدرات أو إستراتيجيات الدراسة بدلاً من ذلك؟",
  "كم الساعة الآن": "عذراً، أنا نظام ذكاء اصطناعي محلي لا أستطيع الوصول إلى الوقت الحالي. أنا مصمم للمساعدة في اختبارات القدرات والأسئلة التعليمية. يمكنك معرفة الوقت من خلال ساعة جهازك أو هاتفك. هل أستطيع مساعدتك في أي استفسار يتعلق باختبارات القدرات أو طرق المذاكرة؟",
  "كم درجة الحرارة في الرياض": "عذراً، لا يمكنني توفير معلومات حالية عن درجات الحرارة أو الطقس لأنني لا أملك اتصالاً بالإنترنت للحصول على هذه البيانات. أنا مصمم للمساعدة في مجال اختبارات القدرات والمعلومات التعليمية. هل يمكنني مساعدتك في أسئلة تتعلق بالقدرات اللفظية أو الكمية بدلاً من ذلك؟"
};

// Create regex patterns from the predefined responses
const RESPONSE_PATTERNS = Object.keys(PREDEFINED_RESPONSES).map(key => {
  const pattern = key
    .replace(/[.*+?^${}()|[\]\\]/g, '\\$&') // Escape special characters
    .replace(/\s+/g, '\\s+');  // Make whitespace flexible
  return { pattern: new RegExp(`^\\s*${pattern}\\s*$`, 'i'), response: PREDEFINED_RESPONSES[key] };
});

const AiAssistant: React.FC<AiAssistantProps> = ({ 
  questions, 
  userLevel = 1,
  onQuestionSelect,
  className 
}) => {
  const [input, setInput] = useState("");
  const [messages, setMessages] = useState<MessageType[]>([]);
  const [isProcessing, setIsProcessing] = useState(false);
  const [copied, setCopied] = useState<string | null>(null);
  const messagesEndRef = useRef<HTMLDivElement>(null);
  const { toast } = useToast();

  // Scroll to bottom when messages change
  useEffect(() => {
    messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
  }, [messages]);

  // Initial welcome message
  useEffect(() => {
    const welcomeMessage: MessageType = {
      id: "welcome",
      text: "أهلاً يا يوسف! أنا مساعد قدراتك. يمكنني مساعدتك في:\n\n" +
      "• أسئلة القدرات اللفظية (التناظر اللفظي، إكمال الجمل، المتضادات)\n" + 
      "• أسئلة القدرات الكمية (النسب، المتواليات، الاحتمالات، الهندسة)\n" +
      "• استراتيجيات المذاكرة والتحضير لاختبار قياس\n" +
      "• شرح أمثلة محلولة من اختبارات سابقة\n\n" + 
      "جرب سؤالي عن 'كيفية حل أسئلة التناظر اللفظي' أو 'مثال سؤال قدرات كمي'",
      sender: "assistant",
      timestamp: new Date(),
      isTyping: true
    };
    setMessages([welcomeMessage]);
  }, []);

  const handleSend = async () => {
    if (!input.trim()) return;

    const userMessage: MessageType = {
      id: Date.now().toString(),
      text: input,
      sender: "user",
      timestamp: new Date(),
    };

    setMessages(prev => [...prev, userMessage]);
    setInput("");
    setIsProcessing(true);

    try {
      // Check for predefined responses
      let response = checkPredefinedResponses(input);
      let additionalInfo = "";

      // For all queries related to capabilities or tests, add extra information
      if (input.includes("قدرات") || /اختبار|امتحان|قياس|كيف|ماذا|مساعد/.test(input)) {
        additionalInfo = "\n\nإليك بعض المعلومات الإضافية التي قد تفيدك:\n" +
          "• يمكنني مساعدتك في أسئلة القدرات اللفظية (مثل التناظر اللفظي، إكمال الجمل، المترادفات والمتضادات)\n" +
          "• يمكنني مساعدتك في أسئلة القدرات الكمية (مثل النسبة والتناسب، المتواليات، نظرية فيثاغورس، الاحتمالات)\n" +
          "• جرب أن تسألني: 'كيفية حل أسئلة التناظر اللفظي' أو 'نموذج سؤال قدرات كمي'";
      }

      // No predefined response, try to search for related questions
      if (!response) {
        // Search for similar questions
        const searchResults = smartSearch(input, questions, { threshold: 0.35, maxResults: 5 });

        if (searchResults.length > 0) {
          const relatedQuestionsText = searchResults.map((result, index) => 
            `${index + 1}. ${result.question.text}`
          ).join('\n');

          response = `وجدت بعض الأسئلة التي قد تكون مفيدة:\n\n${relatedQuestionsText}\n\nهل ترغب في مزيد من المعلومات حول أي من هذه الأسئلة؟`;

          // Add related questions to the message
          const relatedQuestions = searchResults.map(result => result.question);
          
          const assistantMessage: MessageType = {
            id: Date.now().toString(),
            text: response,
            sender: "assistant",
            timestamp: new Date(),
            relatedQuestions
          };

          setMessages(prev => [...prev, assistantMessage]);
          setIsProcessing(false);
          return;
        }

        // If no related questions found, give a generic response
        response = generateGenericResponse(input);
      }

      // Add additional info if available
      if (additionalInfo && !response.includes(additionalInfo)) {
        response += additionalInfo;
      }

      // Send assistant response
      const assistantMessage: MessageType = {
        id: Date.now().toString(),
        text: response,
        sender: "assistant",
        timestamp: new Date(),
      };

      setMessages(prev => [...prev, assistantMessage]);
    } catch (error) {
      console.error('Error in AI response:', error);
      
      // Error message with suggestions
      const errorMessage: MessageType = {
        id: Date.now().toString(),
        text: "عذرًا، حدث خطأ ما. يرجى المحاولة مرة أخرى.\n\nيمكنني مساعدتك في العديد من المواضيع المتعلقة باختبار القدرات، مثل أسئلة التناظر اللفظي، إكمال الجمل، المتواليات العددية، النسبة والتناسب، وغيرها. جرب أن تسألني عن 'نموذج سؤال قدرات كمي' أو 'كيفية حل أسئلة التناظر اللفظي'.",
        sender: "assistant",
        timestamp: new Date(),
      };
      
      setMessages(prev => [...prev, errorMessage]);
    } finally {
      setIsProcessing(false);
    }
  };

  // Check for predefined responses
  const checkPredefinedResponses = (userInput: string): string | null => {
    for (const { pattern, response } of RESPONSE_PATTERNS) {
      if (pattern.test(userInput)) {
        return response;
      }
    }
    return null;
  };

  // Generate a generic response for inputs without matches
  const generateGenericResponse = (userInput: string): string => {
    // Detect if this might be a greeting
    if (/^(سلام|اهلا|هاي|هلا|مرحب|صباح|مساء)/i.test(userInput)) {
      return "أهلاً بك يا يوسف! كيف يمكنني مساعدتك اليوم؟";
    }
    
    // Check for requests about questions directly
    if (/سؤال عن|أسألك عن|اسألني|فسر لي|اشرح|الإجابة|الحل/.test(userInput)) {
      return "يسعدني مساعدتك! اكتب السؤال الذي تريد إجابته أو شرحه بشكل واضح، وسأحاول تقديم الشرح المناسب. يمكنك أيضًا البحث في المكتبة للحصول على أسئلة مشابهة.";
    }
    
    // Detect requests about exams
    if (/اختبار|امتحان|قياس|اخت[بت]ر|تجريبي/.test(userInput)) {
      return "منصة قدراتك تقدم عدة أنواع من الاختبارات: \n1. اختبر قدراتك (من المستوى المبتدئ إلى المتقدم)\n2. اختبار قياس الرسمي بنفس هيكلية اختبار هيئة تقويم التعليم\n3. اختبارات مخصصة يمكنك تصميمها بنفسك\nأي نوع تفضل تجربته؟";
    }
    
    // Detect compliments or criticisms
    if (/شكر|جزيل|ممتاز|رائع|أحسنت|عظيم|أحبك/.test(userInput)) {
      return "شكراً جزيلاً لك! أنا سعيد بأنني استطعت مساعدتك. هدفي هو تقديم أفضل دعم ممكن في رحلتك التعليمية. هل هناك شيء آخر يمكنني مساعدتك به؟";
    }
    
    if (/غبي|فاشل|سيء|ما تفهم|مش فاهم|ما تعرف/.test(userInput)) {
      return "أعتذر إذا لم تكن إجاباتي ترقى لتوقعاتك. أنا أتعلم وأتحسن باستمرار. يمكنك إعادة صياغة سؤالك بطريقة مختلفة أو طرح سؤال آخر وسأبذل قصارى جهدي لمساعدتك.";
    }
    
    // Check for time and date questions
    if (/الساعة|الوقت|التوقيت|كم الساعة|الآن/.test(userInput)) {
      return "عذراً، أنا نظام ذكاء اصطناعي محلي لا أستطيع الوصول إلى الوقت الحالي. أنا مصمم للمساعدة في اختبارات القدرات والأسئلة التعليمية. يمكنك معرفة الوقت من خلال ساعة جهازك. هل يمكنني مساعدتك في أسئلة متعلقة باختبار القدرات؟";
    }
    
    if (/التاريخ|اليوم|الهجري|الميلادي/.test(userInput)) {
      return "عذراً، أنا مساعد محلي لا أستطيع معرفة التاريخ الحالي بدقة. أنا مصمم للمساعدة في أسئلة اختبارات القدرات والمعلومات التعليمية. هل يمكنني مساعدتك في موضوع يتعلق باختبارات القدرات أو إستراتيجيات الدراسة بدلاً من ذلك؟";
    }
    
    // Check for weather, location, or external data questions
    if (/درجة الحرارة|الطقس|الجو|المناخ/.test(userInput)) {
      return "عذراً، لا يمكنني توفير معلومات حول الطقس أو درجات الحرارة، حيث أنني لا أملك اتصالاً بالإنترنت. أنا مساعد محلي مصمم للمساعدة في اختبارات القدرات. هل يمكنني مساعدتك في مجال اختبارات القدرات بدلاً من ذلك؟";
    }
    
    // Detect question patterns with more context 
    if (/كيف|ماذا|لماذا|متى|أين|من|هل/.test(userInput)) {
      if (/نقاط|مستوى|تقدم|ترتيب/.test(userInput)) {
        return "نظام النقاط في منصة قدراتك يعتمد على أدائك في الاختبارات. كلما أجبت على أسئلة أكثر بشكل صحيح، تحصل على نقاط أكثر وترتفع في المستويات. وكلما ارتفع مستواك، تُفتح لك مستويات أصعب من الأسئلة للتحدي.";
      }
      if (/مستويات|صعوبة|سهولة/.test(userInput)) {
        return "تتدرج مستويات الصعوبة في منصة قدراتك من المبتدئ، إلى المتوسط، ثم المتقدم، وصولاً إلى الخبير. عند بداية استخدامك للمنصة، تبدأ بالمستوى المبتدئ، وكلما حققت نتائج جيدة، تنتقل إلى المستويات الأعلى تلقائياً.";
      }
      if (/لهجة|لهجات|فصحى|سعودي|مصري/.test(userInput)) {
        return "تدعم منصة قدراتك عدة لهجات منها الفصحى واللهجة السعودية والمصرية والخليجية. يمكنك اختيار اللهجة المفضلة عند البحث في المكتبة باستخدام خيارات التصفية.";
      }
      if (/مساعد|ذكاء|ذكي|ai|chat/.test(userInput)) {
        return "أنا المساعد الذكي لمنصة قدراتك، مصمم لمساعدتك في البحث عن الأسئلة وشرحها وتقديم نصائح للدراسة. أستخدم تقنيات البحث الذكي المحلية وقاعدة بيانات الأسئلة في المنصة للإجابة على استفساراتك دون الحاجة للاتصال بخدمات ذكاء اصطناعي خارجية.";
      }
      
      return "شكرًا على سؤالك. يمكنني مساعدتك بمعلومات عن منصة قدراتك واختبارات القدرات وقياس وكذلك شرح الأسئلة وطرق الإجابة عليها. حاول طرح سؤالك بطريقة أكثر تحديداً للحصول على إجابة أفضل.";
    }

    // Detect if input seems like a math problem
    if (/\d+|\+|\-|\*|\/|=/.test(userInput)) {
      return "يبدو أنك تسأل عن مسألة رياضية. يمكنك تجربة قسم القدرات الكمية للتدرب على مسائل مشابهة. يمكنني أيضاً شرح طرق حل المسائل الرياضية إذا كتبت المسألة بشكل واضح.";
    }

    // Default fallback
    return "شكرًا لرسالتك يا يوسف. أنا مساعد منصة قدراتك، وأستطيع مساعدتك في العثور على الأسئلة وشرحها، وتقديم معلومات عن اختبارات القدرات وقياس. يمكنك طرح أي سؤال أو استعلام وسأحاول مساعدتك بأفضل ما يمكن.";
  };

  // Handle pressing Enter to send message
  const handleKeyDown = (e: React.KeyboardEvent<HTMLInputElement>) => {
    if (e.key === 'Enter' && !isProcessing) {
      handleSend();
    }
  };

  // Handle selecting a related question
  const handleQuestionClick = (question: TestQuestion) => {
    if (onQuestionSelect) {
      onQuestionSelect(question);
      toast({
        title: "تم اختيار السؤال",
        description: "تم فتح السؤال في المكتبة",
      });
    } else {
      // Show the question details in the chat
      const details = `
السؤال: ${question.text}

الخيارات:
${question.options.map((opt, idx) => `${idx + 1}. ${opt}`).join('\n')}

الإجابة الصحيحة: ${question.options[question.correctOptionIndex]}

${question.explanation ? `الشرح: ${question.explanation}` : ''}
      `;

      const detailsMessage: MessageType = {
        id: Date.now().toString(),
        text: details,
        sender: "assistant",
        timestamp: new Date(),
      };

      setMessages(prev => [...prev, detailsMessage]);
    }
  };

  // Copy message text to clipboard
  const copyToClipboard = (text: string, id: string) => {
    navigator.clipboard.writeText(text)
      .then(() => {
        setCopied(id);
        setTimeout(() => setCopied(null), 2000);
      })
      .catch(err => {
        console.error('Failed to copy: ', err);
        toast({
          title: "فشل في النسخ",
          description: "حدث خطأ أثناء محاولة نسخ النص",
          variant: "destructive",
        });
      });
  };

  // Clear all messages
  const clearMessages = () => {
    const welcomeMessage: MessageType = {
      id: "welcome",
      text: "تم مسح المحادثة. كيف يمكنني مساعدتك اليوم؟",
      sender: "assistant",
      timestamp: new Date(),
    };
    setMessages([welcomeMessage]);
  };

  return (
    <div className={cn("flex flex-col h-full rounded-lg border bg-card shadow", className)}>
      {/* Header */}
      <div className="flex items-center justify-between border-b p-3">
        <div className="flex items-center gap-2">
          <BrainCircuitIcon className="h-5 w-5 text-primary" />
          <h3 className="font-medium">مساعد قدراتي</h3>
        </div>
        <div>
          <Button variant="ghost" size="icon" onClick={clearMessages} title="مسح المحادثة">
            <RefreshCcw className="h-4 w-4" />
          </Button>
        </div>
      </div>

      {/* Messages */}
      <div className="flex-1 overflow-y-auto p-4 space-y-4">
        {messages.map(message => (
          <div
            key={message.id}
            className={cn(
              "flex flex-col max-w-[85%] rounded-lg p-3 relative group",
              message.sender === "user"
                ? "bg-primary text-primary-foreground mr-auto"
                : "bg-muted ml-auto"
            )}
          >
            <div className="whitespace-pre-wrap text-sm">
              {message.isTyping ? (
                <TypingEffect text={message.text} />
              ) : (
                message.text
              )}
            </div>
            
            {/* Related questions */}
            {message.relatedQuestions && message.relatedQuestions.length > 0 && (
              <div className="mt-3 space-y-1.5">
                <Separator />
                <div className="text-xs font-medium flex items-center gap-1 mt-1">
                  <BadgeHelp className="h-3 w-3" />
                  <span>اضغط على سؤال لعرض التفاصيل:</span>
                </div>
                <div className="space-y-1.5">
                  {message.relatedQuestions.map((question, index) => (
                    <div
                      key={question.id}
                      onClick={() => handleQuestionClick(question)}
                      className={cn(
                        "text-xs p-2 rounded cursor-pointer flex items-start gap-1.5",
                        message.sender === "user"
                          ? "bg-primary-foreground/10 hover:bg-primary-foreground/20"
                          : "bg-background hover:bg-accent"
                      )}
                    >
                      <div className="mt-0.5 flex-shrink-0">
                        <BookOpenCheck className="h-3 w-3" />
                      </div>
                      <div>{question.text}</div>
                    </div>
                  ))}
                </div>
              </div>
            )}
            
            {/* Message actions */}
            <div className="absolute top-1 left-1 opacity-0 group-hover:opacity-100 transition-opacity">
              <Button
                variant="ghost"
                size="icon"
                className="h-6 w-6"
                onClick={() => copyToClipboard(message.text, message.id)}
              >
                {copied === message.id ? (
                  <Check className="h-3 w-3" />
                ) : (
                  <Copy className="h-3 w-3" />
                )}
              </Button>
            </div>
            
            {/* Timestamp */}
            <div className="text-xs opacity-50 mt-1 text-right">
              {message.timestamp.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}
            </div>
          </div>
        ))}
        {isProcessing && (
          <div className="flex justify-center">
            <div className="bg-muted px-4 py-2 rounded-lg flex items-center space-x-2">
              <Loader2 className="h-4 w-4 animate-spin ml-2" />
              <span className="text-sm">جاري التفكير...</span>
            </div>
          </div>
        )}
        <div ref={messagesEndRef} />
      </div>

      {/* Input */}
      <div className="border-t p-3">
        <div className="flex gap-2">
          <Input
            placeholder="اكتب سؤالك هنا..."
            value={input}
            onChange={(e) => setInput(e.target.value)}
            onKeyDown={handleKeyDown}
            disabled={isProcessing}
            className="flex-1"
          />
          <Button 
            onClick={handleSend} 
            disabled={isProcessing || !input.trim()}
            size="icon"
          >
            {isProcessing ? (
              <Loader2 className="h-4 w-4 animate-spin" />
            ) : (
              <SendIcon className="h-4 w-4" />
            )}
          </Button>
        </div>
        <div className="mt-1.5 text-xs text-muted-foreground text-center">
          مساعد محلي يستخدم نظام البحث الذكي - لا تتم مشاركة البيانات
        </div>
      </div>
    </div>
  );
};

export default AiAssistant;